//При изменении цены автоматически вычисляется сумма
&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	ТекущиеДанныеТовары = Элементы.Товары.ТекущиеДанные;
	ТекущиеДанныеТовары.Сумма = ТекущиеДанныеТовары.Количество * ТекущиеДанныеТовары.Цена;
КонецПроцедуры


//При изменении количества автоматически вычисляется сумма
&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	ТекущиеДанныеТовары = Элементы.Товары.ТекущиеДанные;
	ТекущиеДанныеТовары.Сумма = ТекущиеДанныеТовары.Количество * ТекущиеДанныеТовары.Цена;
КонецПроцедуры

&НаСервере
Процедура ЗабронироватьНаСервере()
	//Преобразование данных с формы в объект доукмента
	ОбъектДокумента = ДанныеФормыВЗначение(Объект,Тип("ДокументОбъект.ПродажаТоваров"));
	ОбъектДокумента.БронированиеТоваров();
	
	//Отображаем возможные изменения пользователю
	ЗначениеВДанныеФормы(ОбъектДокумента,Объект);
КонецПроцедуры

&НаКлиенте
Процедура Забронировать(Команда)
	ЗабронироватьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыПриАктивизацииСтроки(Элемент)
	
	//Чтобы знать по какому товару считать ост - выясняем, из какой стр ТабЧ нужно его брать
	Стр = Элементы.Товары.ТекущиеДанные;
	//И проверяем, есть ли вообще эта строка в доке!
	Если Стр <> Неопределено Тогда
		ОстатокТовара = ОпределениеОстаткаТовара(Стр.Товар, "ПартииТоваровНаСкладах"); //В кач-ве параметра - ссылка на товар из тек активной стр
	Иначе
		ОстатокТовара = 0;
	КонецЕсли;
	
	//И находим свободные остатки
	Стр = Элементы.Товары.ТекущиеДанные;
	Если Стр <> Неопределено Тогда
		СвободныйОстатокТовара = ОпределениеОстаткаТовара(Стр.Товар, "СвободныеОстатки");
	Иначе
		СвободныйОстатокТовара = 0;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ОпределениеОстаткаТовара(ТекТовар, Регистр)
	Если Регистр = "ПартииТоваровНаСкладах" Тогда
		ОстаткиТов = РегистрыНакопления.ПартииТоваровНаСкладах;  //Эта пременная дает доступ к менеджеру этого регистра
	Иначе
		ОстаткиТов = РегистрыНакопления.СвободныеОстатки;
	КонецЕсли;
	
	ФильтрТов = Новый Структура; //В этой структуре будет фильтр для поиска данного товара на данном складе
	ФильтрТов.Вставить("Номенклатура", ТекТовар);
	ФильтрТов.Вставить("Склад", Объект.Склад);
	
	//определяем временной момент
	Если ЗначениеЗаполнено(Объект.Ссылка) тогда
		//Если док уже был записан - достаем моментВремени из его даты
		ВременнойМомент = Новый МоментВремени(Объект.Дата, Объект.Ссылка);
	Иначе
		//Если док новый (нет ссылки и даты), то берем актуальные остатки
		ВременнойМомент = Неопределено;
	КонецЕсли;
	
	
	Если Регистр = "ПартииТоваровНаСкладах" Тогда
		//Запрос к БД, результат - таблица с нужными строками
		ТаблицаОст = ОстаткиТов.Остатки(ВременнойМомент, ФильтрТов, "Номенклатура", "Количество");
		//Суммирование строк таблицы
		Возврат ТаблицаОст.Итог("Количество");
	Иначе
		ТаблицаОст = ОстаткиТов.Остатки(ВременнойМомент, ФильтрТов, "Номенклатура", "КоличествоВСвободномОстатке");
		Возврат ТаблицаОст.Итог("КоличествоВСвободномОстатке");
	КонецЕсли;
	
	
КонецФункции;
